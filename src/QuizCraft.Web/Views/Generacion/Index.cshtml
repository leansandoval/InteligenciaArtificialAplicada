@{
    ViewData["Title"] = "Generar Flashcards Automáticamente";
}

<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h2 class="text-center mb-4">
                <i class="fas fa-magic text-primary"></i>
                Generar Flashcards Automáticamente
            </h2>
            <p class="text-center text-muted mb-5">
                Convierte tus documentos en flashcards de estudio de forma automática
            </p>
        </div>
    </div>

    <!-- Características de IA -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-warning">
                <div class="card-body">
                    <h5 class="mb-3">
                        <i class="fas fa-robot text-warning"></i> Características:
                    </h5>
                    <div class="row">
                        <div class="col-md-6">
                            <ul class="list-unstyled">
                                <li class="mb-2"><i class="fas fa-brain text-warning me-2"></i> Comprensión contextual</li>
                                <li class="mb-2"><i class="fas fa-lightbulb text-warning me-2"></i> Preguntas inteligentes</li>
                                <li class="mb-2"><i class="fas fa-edit text-warning me-2"></i> Respuestas elaboradas</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <ul class="list-unstyled">
                                <li class="mb-2"><i class="fas fa-bolt text-warning me-2"></i> Calidad superior</li>
                                <li class="mb-2"><i class="fas fa-coins text-danger me-2"></i> Requiere tokens</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Formulario de Generación -->
    <div id="formularioGeneracion" class="row">
        <div class="col-12">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <h4><i class="fas fa-upload"></i> Configurar Generación</h4>
                </div>
                <div class="card-body">
                    <form id="formGeneracion" enctype="multipart/form-data">
                        <div class="row">
                            <!-- Selección de Archivo -->
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="documento" class="form-label">
                                        <i class="fas fa-file"></i> Documento
                                    </label>
                                    <input type="file" class="form-control" id="documento" name="documento" 
                                           accept=".txt,.pdf,.docx,.pptx" required>
                                    <div class="form-text">
                                        Tipos soportados: @string.Join(", ", ViewBag.SupportedFileTypes)
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="materiaId" class="form-label">
                                        <i class="fas fa-book"></i> Materia
                                    </label>
                                    <select class="form-select" id="materiaId" name="materiaId" required>
                                        <option value="">Seleccionar materia...</option>
                                        @foreach (var materia in ViewBag.Materias)
                                        {
                                            <option value="@materia.Id">@materia.Nombre</option>
                                        }
                                    </select>
                                </div>
                            </div>

                            <!-- Configuración -->
                            <div class="col-md-6">
                                <div id="configuracionAI" class="configuracion-panel">
                                    <h6><i class="fas fa-robot"></i> Configuración IA</h6>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Máximo de flashcards</label>
                                        <input type="number" class="form-control" 
                                               name="maxCards" value="10" min="1" max="20">
                                        <div class="form-text">Límite: 20 flashcards por generación</div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Dificultad</label>
                                        <select class="form-select" name="difficulty">
                                            <option value="Easy">Fácil</option>
                                            <option value="Medium" selected>Medio</option>
                                            <option value="Hard">Difícil</option>
                                        </select>
                                    </div>

                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" 
                                               name="includeExplanations" checked id="includeExplanations">
                                        <label class="form-check-label" for="includeExplanations">
                                            Incluir explicaciones
                                        </label>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Área de enfoque (opcional)</label>
                                        <input type="text" class="form-control" 
                                               name="focusArea" placeholder="Ej: Matemáticas, Historia">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Botones de Acción -->
                        <div class="row mt-4">
                            <div class="col-12 text-center">
                                <button type="button" class="btn btn-outline-info me-2" id="btnVistaPrevia">
                                    <i class="fas fa-eye"></i> Vista Previa
                                </button>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-magic"></i> Generar Flashcards
                                </button>
                                <button type="button" class="btn btn-secondary ms-2" id="btnCancelar">
                                    <i class="fas fa-times"></i> Cancelar
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Área de Resultados -->
    <div id="areaResultados" class="row mt-4" style="display: none;">
        <div class="col-12">
            <div class="card border-success">
                <div class="card-header bg-success text-white">
                    <h4><i class="fas fa-check-circle"></i> Flashcards Generadas</h4>
                </div>
                <div class="card-body">
                    <div id="estadisticasGeneracion" class="mb-3"></div>
                    <div id="listaFlashcards"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Vista Previa -->
    <div class="modal fade" id="modalVistaPrevia" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-eye"></i> Vista Previa</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="contenidoVistaPrevia"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-success" id="btnConfirmarGeneracion">
                        <i class="fas fa-check"></i> Confirmar y Generar Todas
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
        // Verificar que jQuery esté disponible
        if (typeof $ === 'undefined') {
            console.error('jQuery no está cargado');
        }
        
        $(document).ready(function() {
            const modoSeleccionado = 'ai'; // Siempre usar modo IA

            // Verificar disponibilidad de IA al cargar
            verificarDisponibilidadIA();

            // Cancelar
            $('#btnCancelar').on('click', function(e) {
                window.location.href = '@Url.Action("Index", "Flashcard")';
            });

            // Vista previa
            $('#btnVistaPrevia').on('click', function(e) {
                if (!validarFormulario()) return;

                const formData = new FormData();
                
                // Datos básicos
                const archivo = $('#documento')[0].files[0];
                formData.append('documento', archivo);
                formData.append('modo', modoSeleccionado);

                // Configuraciones específicas del modo
                if (modoSeleccionado === 'traditional') {
                    const config = $('#configuracionTraditional');
                    formData.append('config.MaxCards', config.find('input[name="maxCards"]').val());
                    formData.append('config.SplitByParagraph', config.find('input[name="splitByParagraph"]').is(':checked'));
                    formData.append('config.DetectQuestions', config.find('input[name="detectQuestions"]').is(':checked'));
                    formData.append('config.UseStructural', config.find('input[name="useStructural"]').is(':checked'));
                    formData.append('config.FilterShort', config.find('input[name="filterShort"]').is(':checked'));
                    formData.append('config.CustomSeparator', config.find('input[name="customSeparator"]').val() || '');
                } else {
                    const config = $('#configuracionAI');
                    formData.append('config.MaxCards', config.find('input[name="maxCards"]').val());
                    formData.append('config.Difficulty', config.find('select[name="difficulty"]').val());
                    formData.append('config.IncludeExplanations', config.find('input[name="includeExplanations"]').is(':checked'));
                    formData.append('config.FocusArea', config.find('input[name="focusArea"]').val() || '');
                }

                mostrarCargando('Generando vista previa...');

                $.ajax({
                    url: '@Url.Action("VistaPrevia", "Generacion")',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        ocultarCargando();
                        if (response.success) {
                            mostrarVistaPrevia(response);
                        } else {
                            mostrarError(response.message || 'Error desconocido');
                        }
                    },
                    error: function(xhr, status, error) {
                        ocultarCargando();
                        mostrarError('Error de conexión: ' + error);
                    }
                });
            });

            // Generar flashcards
            $('#formGeneracion').on('submit', function(e) {
                e.preventDefault();
                console.log('Form submitted, modo:', modoSeleccionado);
                
                if (!validarFormulario()) return;

                const formData = new FormData();
                
                // Datos básicos
                formData.append('documento', $('#documento')[0].files[0]);
                formData.append('materiaId', $('#materiaId').val());
                formData.append('modo', 'ai');

                // Configuración IA
                const config = $('#configuracionAI');
                formData.append('config.MaxCards', config.find('input[name="maxCards"]').val());
                formData.append('config.Difficulty', config.find('select[name="difficulty"]').val());
                formData.append('config.IncludeExplanations', config.find('input[name="includeExplanations"]').is(':checked'));
                formData.append('config.FocusArea', config.find('input[name="focusArea"]').val() || '');

                mostrarCargando('Generando flashcards...');

                $.ajax({
                    url: '@Url.Action("GenerarFlashcards", "Generacion")',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        ocultarCargando();
                        if (response.success) {
                            // Mostrar mensaje de éxito breve y redirigir
                            $('#result').html(`
                                <div class="alert alert-success">
                                    <h5>¡Flashcards generadas exitosamente!</h5>
                                    <p>Se generaron ${response.flashcardCount} flashcards.</p>
                                    <p>Tiempo de procesamiento: ${(response.processingTime || 0).toFixed(2)} segundos</p>
                                    <p>Redirigiendo para revisar las flashcards...</p>
                                </div>
                            `);
                            
                            // Redirigir después de un breve delay
                            setTimeout(function() {
                                window.location.href = response.redirectUrl;
                            }, 2000);
                        } else {
                            mostrarError(response.message || 'Error desconocido');
                        }
                    },
                    error: function(xhr, status, error) {
                        ocultarCargando();
                        mostrarError('Error de conexión: ' + error);
                    }
                });
            });

            // Confirmar generación desde vista previa
            $('#btnConfirmarGeneracion').on('click', function(e) {
                $('#modalVistaPrevia').modal('hide');
                $('#formGeneracion').submit();
            });

            function validarFormulario() {
                const documento = $('#documento')[0].files[0];
                const materiaId = $('#materiaId').val();

                if (!modoSeleccionado) {
                    mostrarError('Debe seleccionar un modo de procesamiento');
                    return false;
                }

                if (!documento) {
                    mostrarError('Debe seleccionar un archivo');
                    return false;
                }

                if (!materiaId) {
                    mostrarError('Debe seleccionar una materia');
                    return false;
                }

                // Validar tipos de archivo
                const allowedTypes = ['.txt', '.pdf', '.docx', '.pptx'];
                const fileName = documento.name.toLowerCase();
                const isValidType = allowedTypes.some(type => fileName.endsWith(type));
                
                if (!isValidType) {
                    mostrarError('Tipo de archivo no soportado. Use: ' + allowedTypes.join(', '));
                    return false;
                }

                return true;
            }

            function mostrarVistaPrevia(response) {
                let html = `
                    <div class="alert alert-info">
                        <strong>Vista previa:</strong> Mostrando hasta 5 flashcards de ${response.totalPossible} posibles.
                        <br><strong>Modo:</strong> ${response.modeUsed}
                    </div>
                `;

                response.flashcards.forEach((card, index) => {
                    html += `
                        <div class="card mb-2">
                            <div class="card-body">
                                <h6 class="card-title">Flashcard ${index + 1}</h6>
                                <p><strong>Pregunta:</strong> ${card.pregunta}</p>
                                <p><strong>Respuesta:</strong> ${card.respuesta}</p>
                                <small class="text-muted">
                                    Confianza: ${card.confidence}% | Fuente: ${card.source}
                                </small>
                            </div>
                        </div>
                    `;
                });

                $('#contenidoVistaPrevia').html(html);
                $('#modalVistaPrevia').modal('show');
            }

            function mostrarResultados(response) {
                const estadisticas = `
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="bg-primary text-white p-3 rounded">
                                <h4>${response.flashcards.length}</h4>
                                <small>Flashcards Creadas</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="bg-info text-white p-3 rounded">
                                <h4>${(response.processingTime || 0).toFixed(2)}s</h4>
                                <small>Tiempo de Procesamiento</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="bg-success text-white p-3 rounded">
                                <h4>${response.modeUsed}</h4>
                                <small>Modo Utilizado</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="bg-warning text-white p-3 rounded">
                                <h4>100%</h4>
                                <small>Éxito</small>
                            </div>
                        </div>
                    </div>
                `;

                let listaHtml = '<div class="row">';
                response.flashcards.forEach((card, index) => {
                    listaHtml += `
                        <div class="col-md-6 mb-3">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6 class="card-title">Flashcard ${index + 1}</h6>
                                    <p class="card-text"><strong>P:</strong> ${card.pregunta}</p>
                                    <p class="card-text"><strong>R:</strong> ${card.respuesta}</p>
                                    <small class="text-muted">
                                        <i class="fas fa-chart-line"></i> ${card.confidence}% | 
                                        <i class="fas fa-map-marker-alt"></i> ${card.source}
                                    </small>
                                </div>
                            </div>
                        </div>
                    `;
                });
                listaHtml += '</div>';

                $('#estadisticasGeneracion').html(estadisticas);
                $('#listaFlashcards').html(listaHtml);
                $('#areaResultados').show();

                // Scroll a resultados
                $('html, body').animate({
                    scrollTop: $('#areaResultados').offset().top - 20
                }, 500);

                mostrarExito(response.message);
            }

            function mostrarCargando(mensaje) {
                console.log('Mostrando cargando:', mensaje);
                if (typeof Swal === 'undefined') {
                    console.error('SweetAlert2 no está disponible');
                    return;
                }
                Swal.fire({
                    title: 'Procesando...',
                    text: mensaje,
                    allowOutsideClick: false,
                    showConfirmButton: false,
                    willOpen: () => {
                        Swal.showLoading();
                    }
                });
            }

            function ocultarCargando() {
                Swal.close();
            }

            function mostrarExito(mensaje) {
                Swal.fire({
                    icon: 'success',
                    title: '¡Éxito!',
                    text: mensaje,
                    timer: 3000
                });
            }

            function mostrarError(mensaje) {
                console.log('Mostrando error:', mensaje);
                if (typeof Swal === 'undefined') {
                    console.error('SweetAlert2 no está disponible, usando modal Bootstrap');
                    mostrarModalAlerta({
                        titulo: 'Error',
                        mensaje: mensaje,
                        tipo: 'danger',
                        icono: 'fas fa-exclamation-circle'
                    });
                    return;
                }
                
                // Formatear mensaje para mejor visualización
                const mensajeHtml = mensaje
                    .replace(/\n/g, '<br>')
                    .replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" style="color: #0d6efd; text-decoration: underline;">$1</a>');
                
                Swal.fire({
                    icon: 'error',
                    title: 'Error en el procesamiento con IA',
                    html: `<div style="text-align: left; line-height: 1.8; font-size: 0.95rem;">${mensajeHtml}</div>`,
                    width: '600px',
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#dc3545',
                    customClass: {
                        popup: 'swal-error-popup',
                        htmlContainer: 'swal-html-container'
                    }
                });
            }

            function verificarDisponibilidadIA() {
                $.ajax({
                    url: '@Url.Action("VerificarDisponibilidadIA", "Generacion")',
                    type: 'GET',
                    success: function(data) {
                        if (data.disponible && data.tieneCreditos) {
                            $('#estadoIA').html('<i class="fas fa-check text-success"></i> ' + data.mensaje);
                            $('#btnModoIA').prop('disabled', false);
                        } else {
                            $('#estadoIA').html('<i class="fas fa-exclamation-triangle text-warning"></i> ' + data.mensaje);
                            $('#btnModoIA').prop('disabled', true);
                        }
                    },
                    error: function() {
                        $('#estadoIA').html('<i class="fas fa-times text-danger"></i> Error verificando IA');
                        $('#btnModoIA').prop('disabled', true);
                    }
                });
            }
        });
    </script>
}

<style>
    .card {
        transition: all 0.3s ease;
    }

    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }

    .configuracion-panel {
        background-color: #f8f9fa;
        padding: 1.5rem;
        border-radius: 0.5rem;
        border: 1px solid #dee2e6;
    }

    .card-body ul li {
        margin-bottom: 0.5rem;
    }
    
    #btnModoIA:disabled {
        cursor: not-allowed;
        opacity: 0.6;
    }
    
    /* Estilos personalizados para SweetAlert2 de error */
    .swal-error-popup {
        border-left: 5px solid #dc3545 !important;
    }
    
    .swal-html-container {
        padding: 1rem 0.5rem !important;
        margin: 0 !important;
    }
    
    .swal2-icon.swal2-error {
        border-color: #dc3545 !important;
        color: #dc3545 !important;
    }
    
    .swal2-icon.swal2-error [class^='swal2-x-mark-line'] {
        background-color: #dc3545 !important;
    }
</style>